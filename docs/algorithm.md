# 育成パターン計算アルゴリズム

実装: [backend/src/race/race-pattern.service.ts](../backend/src/race/race-pattern.service.ts)

## 問題の背景

全冠対象レースは **155個**、育成で出走できるターン（スロット）は**最大 60**（ジュニア 12 + クラシック 24 + シニア 24）です。
1回の育成ですべてを消化することは不可能なため、残レースを複数の育成ローテーションに分配する必要があります。

さらに以下の制約が絡み合います。

- 同一スロット（月・前後半）には 1レースしか出走できない
- 連続 4 戦以上の出走は禁止（ゲームルール）
- シナリオ（伝説）では特定レースが目標として固定される
- L'Arc（ラーク）シナリオはクラシック 7〜10 月・シニア 6 月後半以降の自由出走が禁止

## 旧実装の問題点（逐次 Greedy）

初期実装は「1パターンのスロットを前から順に埋めていく」逐次 Greedy 方式でした。
**前詰め問題**があり、早いスロットにレースが集中して後半のパターンに偏りが生じ、パターン数が過剰になるという欠点がありました。

## 現行実装：グリッドベース一括割り当て

### Phase 1 — スロット圧力によるパターン数の決定

各残レースは走れる期（ジュニア / クラシック / シニア）に応じてスロットに**ウェイト**を分配します。

```
classic のみ出走可  → そのスロットに weight = 1.0
classic + senior 両方 → 各スロットに weight = 0.5
```

全スロットのウェイト合計（**圧力**）を求め、最大値の `ceil` が必要メイクラパターン数になります。

```
Nメイクラ = ceil( max(圧力[S]) for all S )
N合計     = Nメイクラ + (シナリオレースが存在すれば +1)
```

### Phase 2 — グリッドへの一括割り当て

`Grid[patternIndex][slotKey]` という 2 次元構造に対して全残レースを一括で割り当てます。
割り当て順は「配置できるスロットが少ない（制約が厳しい）レースを先に」とし、各候補に以下のスコアを付けて最良手を選択します。

| スコア要素 | 概要 |
|-----------|------|
| 因子戦略一致 | ウマ娘の不足因子（バ場・距離）と一致すれば +2〜+4 |
| 連続出走抑制 | 前後のスロットへの連続配置が長いほど減点 |
| グレード優先 | G1 > G2 > G3 の順に優先配置 |

### 制約の実装

| 制約 | 処理 |
|------|------|
| 連続 4 戦禁止 | スロット線形順序（60スロット通し番号）上で隣接スロットを走査し、連続長が 3 以上になる配置を禁止。シナリオ固定レースはカウント対象外 |
| L'Arc 制限スロット | ラーク候補パターンでは classic 7〜10 月前半・senior 6 月後半以降への通常レース配置を禁止 |
| シナリオレース分離 | 通常割り当て対象から除外し、伝説パターン（index=0）に固定配置 |

### Phase 3 — パターン後処理

グリッドから各パターンのスロット配列（junior / classic / senior）を構築し、
ラーク変換判定・シナリオ名確定（伝説 / ラーク / メイクラ）・因子構成計算・主バ場/距離の集計を行います。

## 参考

- Qiita 記事: [ウマ娘の全冠称号を効率化！レースパターン計算機能を作ってみた](https://qiita.com/spepepepe/items/98263fe0637ac280d7a7)
- 設計ノート: [script/レースパターン計算設計.md](../script/レースパターン計算設計.md)
